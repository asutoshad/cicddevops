name: Trivy Security Scan

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  trivy-security-scan:
    runs-on: ubuntu-latest


    permissions:
      contents: write
      pages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies and build backend1
        run: |
          yarn install --frozen-lockfile
          npm run build
        working-directory: ./backend1

      - name: Install dependencies and build backend2
        run: |
          yarn install --frozen-lockfile
          npm run build
        working-directory: ./backend2

      - name: Install dependencies and build frontend
        run: |
          yarn install --frozen-lockfile
          npm run build
        working-directory: ./frontend

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend1 image
        run: docker build -t backend1-image ./backend1

      - name: Build backend2 image
        run: docker build -t backend2-image ./backend2

      - name: Build frontend image
        run: docker build -t frontend-image ./frontend

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Download Trivy HTML template
        run: |
          wget https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -O trivy-html.tpl

      - name: Run Trivy on backend1
        run: trivy image --format template --template "@trivy-html.tpl" -o backend1-report.html backend1-image

      - name: Run Trivy on backend2
        run: trivy image --format template --template "@trivy-html.tpl" -o backend2-report.html backend2-image

      - name: Run Trivy on frontend
        run: trivy image --format template --template "@trivy-html.tpl" -o frontend-report.html frontend-image

      - name: Combine Reports into index.html
        run: |
          mkdir -p scan
          echo "<html><head><title>Trivy Security Scan Report</title></head><body>" > scan/index.html
          echo "<h1>Trivy Scan Report</h1>" >> scan/index.html

          echo "<h2>Frontend</h2>" >> scan/index.html
          cat frontend-report.html >> scan/index.html

          echo "<h2>Backend1</h2>" >> scan/index.html
          cat backend1-report.html >> scan/index.html

          echo "<h2>Backend2</h2>" >> scan/index.html
          cat backend2-report.html >> scan/index.html

          echo "</body></html>" >> scan/index.html

      - name: Deploy Scan Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./scan
          publish_branch: gh-pages